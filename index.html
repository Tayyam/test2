<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hotel Booking</title>
<style>
  table, th, td {
    border: 1px solid black;
    border-collapse: collapse;
  }
  th, td {
    padding: 5px;
    text-align: center;
    cursor: pointer;
  }
  th {
    background-color: #f2f2f2;
    cursor: default;
  }
  .mainMakkah { background-color: #ffcccc; }
  .shiftingMakkah { background-color: #ccccff; }
  .madinah { background-color: #ccffcc; }
</style>
</head>
<body>

<select id="hotelLocation">
  <option value="">Select Location</option>
  <option value="mainMakkah">Main Makkah</option>
  <option value="shiftingMakkah">Shifting Makkah</option>
  <option value="madinah">Madinah</option>
</select>
<br>
<button onclick="addRoomLine()">Add Room Line</button>
<br><br>
<table id="bookingTable"></table>
<br>

Room Type (Main Makkah/Madinah): 
<select id="roomType">
  <option value="double">Double</option>
  <option value="triple">Triple</option>
  <option value="quadruple">Quadruple</option>
</select>

Number of Rooms (Main Makkah/Madinah): 
<input type="number" id="roomCount" value="0">
<br>

Room Type (Shifting Makkah): 
<select id="shiftingMakkahRoomType">
  <option value="double">Double</option>
  <option value="triple">Triple</option>
  <option value="quadruple">Quadruple</option>
</select>

Number of Rooms (Shifting Makkah): 
<input type="number" id="shiftingMakkahRoomCount" value="0">
<br><br>

<button onclick="calculate()">Calculate</button>

<h3>Summary:</h3>
<table id="summaryTable">
  <tr>
    <th>ID</th>
    <th>Area</th>
    <th>From</th>
    <th>To</th>
    <th>Room</th>
    <th>Room Type</th>
    <th>Pilgrims</th>
  </tr>
</table>


<script>
var selectedDates = {}; // Structure: { 'rowID-date': 'location' }
    var roomLineCounter = 0; // Initialization of roomLineCounter

    window.onload = function() {
        createInitialRoomLines(10);
    };
    
    function createInitialRoomLines(numberOfLines) {
        for (let i = 0; i < numberOfLines; i++) {
            addRoomLine();
        }
    }
    
    function addRoomLine() {
        var bookingTable = document.getElementById('bookingTable');
        if (roomLineCounter === 0) { // Add header only once
            var headerRow = bookingTable.insertRow();
            headerRow.insertCell().textContent = "ID"; // ID Column
            for (var day = 1; day <= 30; day++) {
                headerRow.insertCell().textContent = day + "/6";
            }
        }
    
        roomLineCounter++;
        var row = bookingTable.insertRow();
        var idCell = row.insertCell();
        idCell.textContent = roomLineCounter; // Display the ID of the room line
        for (var day = 1; day <= 30; day++) {
            var cell = row.insertCell();
            cell.textContent = "-";
            cell.setAttribute("data-date", `${day}/6`);
            cell.setAttribute("data-id", roomLineCounter);
            cell.onclick = function() { selectCell(this); };
        }
    }

    // Function to update the display based on selected dates
    function updateCellDisplay() {
    var cells = document.querySelectorAll('#bookingTable td[data-date]');
    cells.forEach(cell => {
        var date = cell.getAttribute('data-date');
        var id = cell.getAttribute('data-id');
        var key = id + '-' + date;
        
        if (selectedDates[key]) {
            // Example logic to determine what text to display
            cell.textContent = selectedDates[key].charAt(0).toUpperCase();
        } else {
            cell.textContent = '-'; // Reset cells not selected to be visually empty
        }
    });
}
    
function selectCell(cell) {
    var date = cell.getAttribute('data-date');
    var id = cell.getAttribute('data-id');
    var location = document.getElementById('hotelLocation').value;
    var roomCount = location === 'shiftingMakkah' ? document.getElementById('shiftingMakkahRoomCount').value : document.getElementById('roomCount').value;

    if (!location) {
        alert('Please select a location first.');
        return;
    }

    var key = id + '-' + date;
    if (selectedDates[key]) {
        // If cell is already selected, deselect it
        delete selectedDates[key];
        cell.style.backgroundColor = ''; // Reset cell color
        cell.textContent = "-"; // Reset cell text
    } else {
        selectedDates[key] = { location: location, roomCount: roomCount };
        cell.style.backgroundColor = getLocationColor(location);
        cell.textContent = roomCount; // Display the number of rooms

        // After marking the clicked cell, check and apply selection for in-between cells
        selectCellAndInRange(cell, id, roomCount, location);
    }

    updateCellDisplay();
}

function selectCellAndInRange(clickedCell, rowId, roomCount, location) {
    let rowCells = Array.from(clickedCell.parentNode.querySelectorAll('td[data-date]'));
    let clickedIndex = rowCells.indexOf(clickedCell);
    let firstSelectedIndex = null;
    let lastSelectedIndex = null;

    // Identify the first and last selected indexes in the same row
    rowCells.forEach((cell, index) => {
        if (selectedDates[rowId + '-' + cell.getAttribute('data-date')]) {
            if (firstSelectedIndex === null) firstSelectedIndex = index;
            lastSelectedIndex = index; // Keep updating to the last found
        }
    });

    // If there's a range to select (i.e., both first and last selections are made)
    if (firstSelectedIndex !== null && lastSelectedIndex !== null && firstSelectedIndex !== lastSelectedIndex) {
        for (let i = firstSelectedIndex; i <= lastSelectedIndex; i++) {
            let cell = rowCells[i];
            let key = rowId + '-' + cell.getAttribute('data-date');
            if (!selectedDates[key]) { // Select only if not already selected
                selectedDates[key] = { location: location, roomCount: roomCount };
                cell.style.backgroundColor = getLocationColor(location);
                cell.textContent = roomCount;
            }
        }
    }
}




// Helper functions for the new logic

function getLocationColor(location) {
    switch(location) {
        case 'mainMakkah': return '#ffcccc';
        case 'shiftingMakkah': return '#ccccff';
        case 'madinah': return '#ccffcc';
        default: return '';
    }
}

function handleDeselection(cell, id, date) {
    // Identify contiguous selection range that includes the cell to be deselected
    var contiguousRange = findContiguousRange(cell, id);
    // Remove all cells in the identified range from selectedDates
    contiguousRange.forEach(cellDate => {
        var key = id + '-' + cellDate;
        delete selectedDates[key];
    });
    // Update the UI to reflect the changes
    updateCellDisplay();
}

function findContiguousRange(cell, id) {
    var cellDate = cell.getAttribute('data-date');
    var cellIndex = Array.from(cell.parentNode.cells).indexOf(cell);
    var dates = [];

    // Look backwards to find the start of the contiguous range
    for (let i = cellIndex; i >= 0; i--) {
        var currentCell = cell.parentNode.cells[i];
        var currentDate = currentCell.getAttribute('data-date');
        var key = id + '-' + currentDate;
        if (selectedDates[key]) {
            dates.push(currentDate);
        } else {
            break; // Stop if we hit a cell that's not part of the contiguous range
        }
    }

    // Look forwards to find the end of the contiguous range
    for (let i = cellIndex + 1; i < cell.parentNode.cells.length; i++) {
        var currentCell = cell.parentNode.cells[i];
        var currentDate = currentCell.getAttribute('data-date');
        var key = id + '-' + currentDate;
        if (selectedDates[key]) {
            dates.push(currentDate);
        } else {
            break; // Stop if we hit a cell that's not part of the contiguous range
        }
    }

    return dates;
}

function updateCellDisplay() {
    // Retrieve all cells in the booking table that have a date attribute
    var cells = document.querySelectorAll('#bookingTable td[data-date]');
    cells.forEach(cell => {
        var id = cell.getAttribute('data-id');
        var date = cell.getAttribute('data-date');
        var key = id + '-' + date;
        
        if (selectedDates[key]) {
            // If the cell is selected, display the number of rooms and apply the background color
            cell.textContent = selectedDates[key].roomCount;
            cell.style.backgroundColor = getLocationColor(selectedDates[key].location);
        } else {
            // If the cell is not selected, reset its display
            cell.textContent = '-';
            cell.style.backgroundColor = ''; // Reset the background color
        }
    });
}
function getRoomCountByLocation(location) {
    // You can expand this logic based on your application's needs
    switch(location) {
        case "mainMakkah": return document.getElementById('roomCount').value;
        case "shiftingMakkah": return document.getElementById('shiftingMakkahRoomCount').value;
        // Add more cases as needed
        default: return 0;
    }
}

function deselectCellsStartingFrom(cell) {
    // Additional logic to only deselect cells until another selection or the clicked cell itself
    let currentRowCells = Array.from(cell.parentNode.querySelectorAll('td[data-date]'));
    let cellIndex = currentRowCells.indexOf(cell);

    for (let i = cellIndex; i < currentRowCells.length; i++) {
        let cellKey = `${currentRowCells[i].getAttribute('data-id')}-${currentRowCells[i].getAttribute('data-date')}`;
        if (selectedDates[cellKey]) {
            delete selectedDates[cellKey];
            currentRowCells[i].textContent = "-";
            currentRowCells[i].style.backgroundColor = ""; // Remove background color
        }
    }
}




        // Function to calculate and generate the summary table
    function calculate() {
    var roomType = document.getElementById('roomType').value;
    var roomCount = parseInt(document.getElementById('roomCount').value, 10);
    var totalPilgrims = calculatePilgrims(roomType, roomCount);

    // Calculation for Shifting Makkah
    adjustShiftingMakkahRoomCount(totalPilgrims);

    // Proceed with summary generation and display update
    clearSummaryRows();
    var groupedData = groupSelectedDatesByLineAndLocation();
    displayGroupedData(groupedData);
}
function adjustShiftingMakkahRoomCount(totalPilgrims) {
    var shiftingMakkahRoomTypeSelected = document.getElementById('shiftingMakkahRoomType').value;
    var shiftingCapacity = { double: 2, triple: 3, quadruple: 4 }[shiftingMakkahRoomTypeSelected];
    var shiftingMakkahRoomCount = totalPilgrims / shiftingCapacity;

    if (Math.ceil(shiftingMakkahRoomCount) * shiftingCapacity !== totalPilgrims) {
        alert(`Shifting Makkah room type ${shiftingMakkahRoomTypeSelected} cannot accommodate all pilgrims equally without affecting the total number of pilgrims. Adjusting room count or room type is required.`);
        // Here, you might choose not to revert but perhaps adjust the count directly or prompt for manual adjustment
        document.getElementById('shiftingMakkahRoomCount').value = Math.ceil(shiftingMakkahRoomCount); // Suggestion for adjustment
    } else {
        document.getElementById('shiftingMakkahRoomCount').value = Math.ceil(shiftingMakkahRoomCount); // Update the input field if calculation is valid
    }
}
    
    function clearSummaryRows() {
        var summaryTable = document.getElementById('summaryTable');
        while (summaryTable.rows.length > 1) {
            summaryTable.deleteRow(1);
        }
    }
    
    // Generate the summary based on selectedDates
    function generateSummary() {
    clearSummaryRows();
    var groupedData = groupSelectedDatesByLineAndLocation();
    displayGroupedData(groupedData);
}

function groupSelectedDatesByLineAndLocation() {
    let groupedData = {};

    Object.entries(selectedDates).forEach(([key, value]) => {
        const [id, date] = key.split('-');
        const location = value.location; // Now correctly extracting location from the value object
        const dateObj = new Date(date.split('/')[1] + '/' + date.split('/')[0] + '/2024');

        if (!groupedData[`${id}-${location}`]) {
            groupedData[`${id}-${location}`] = [];
        }
        groupedData[`${id}-${location}`].push(dateObj);
    });

    Object.keys(groupedData).forEach(group => {
        groupedData[group].sort((a, b) => a - b);
        const ranges = groupedData[group].reduce((acc, current, index, array) => {
            if (index === 0) {
                acc.push({ start: current, end: current });
            } else {
                let lastRange = acc[acc.length - 1];
                let difference = (current - lastRange.end) / (1000 * 60 * 60 * 24);
                if (difference === 1) {
                    lastRange.end = current;
                } else {
                    acc.push({ start: current, end: current });
                }
            }
            return acc;
        }, []);

        groupedData[group] = ranges.map(range => ({
            start: formatDate(range.start),
            end: formatDate(range.end),
            // roomCount and roomType now need to be extracted in a different way
            roomCount: document.getElementById('roomCount').value, // This needs adjustment
            roomType: document.getElementById('roomType').value, // This needs adjustment
        }));
    });

    return groupedData;
}

function displayGroupedData(groupedData) {
    var summaryTable = document.getElementById('summaryTable');
    Object.entries(groupedData).forEach(([key, ranges]) => {
        const [id, location] = key.split('-');

        ranges.forEach(range => {
            let row = summaryTable.insertRow();
            row.insertCell(0).textContent = id;
            row.insertCell(1).textContent = location;
            row.insertCell(2).textContent = range.start;
            row.insertCell(3).textContent = range.end;
            row.insertCell(4).textContent = range.roomCount; // This needs correct data
            row.insertCell(5).textContent = range.roomType; // This needs correct data
            row.insertCell(6).textContent = calculatePilgrims(range.roomType, range.roomCount);
        });
    });
}


    
    // Calculate Pilgrims (Placeholder function, implement logic as needed)
    function calculatePilgrims(roomType, roomCount) {
        const pilgrimMap = { double: 2, triple: 3, quadruple: 4 };
        return pilgrimMap[roomType] * roomCount;
    }
    
    // Format date (Placeholder function, format date as needed)
    function formatDate(date) {
    return `${('0' + date.getDate()).slice(-2)}/${('0' + (date.getMonth() + 1)).slice(-2)}`;
}
    </script>
    
    
    

</body>
</html>
